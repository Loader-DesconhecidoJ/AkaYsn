--[[
    SANDEVISTAN DAVID MARTINEZ - V21 HARDCORE EDITION
    - SISTEMA DE EXAUSTÃO: 0 energia = Fadiga + Tontura (2s) + Delay de Regen (10s)
    - REGEN DINÂMICA: 5s se não zerar / 10s se zerar
    - ESTÉTICA: Bordas Neon Amarela (Dash) e Ciano (Slow Time)
    - RASTRO: Ciano -> Roxo (Somente em movimento)
]]

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Debris = game:GetService("Debris")
local Lighting = game:GetService("Lighting")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- CONFIGURAÇÃO
local CONFIG = {
    MAX_ENERGY = 200,
    DASH_COST = 15,
    SLOW_START_COST = 25,
    
    REGEN_SPEED = 25,
    NORMAL_REGEN_DELAY = 5, -- Delay se não zerar
    EXHAUSTED_REGEN_DELAY = 10, -- Delay se chegar a 0
    
    SANDI_SPEED_MULT = 5.0,
    DASH_FORCE = 260,
    
    MAIN_COLOR = Color3.fromRGB(0, 255, 220),  -- Ciano
    PURPLE_COLOR = Color3.fromRGB(180, 0, 255), -- Roxo
    SECONDARY_COLOR = Color3.fromRGB(255, 255, 0), -- Amarelo
    HEALTH_COLOR = Color3.fromRGB(255, 50, 70),
    
    BG_DEFAULT = Color3.fromRGB(10, 10, 10),
    
    -- SONS
    SOUND_ACTIVATE = 123844681344865,
    SOUND_DEACTIVATE = 118534165523355,
    SOUND_DASH = 103247005619946,
    SOUND_ERROR = 3338392183
}

-- ESTADO
local State = {
    Energy = 200,
    SlowActive = false,
    CanDash = true,
    CanSandi = true,
    DragMode = false,
    IsExhausted = false,
    CurrentRegenDelay = CONFIG.NORMAL_REGEN_DELAY,
    LastEnergyUse = tick(),
    Connections = {}
}

local ScreenGui, EnergyFill, HealthFill, DashBtn, SlowBtn

-- UTILITÁRIOS
local function playLocalSound(id, vol)
    local s = Instance.new("Sound", game:GetService("SoundService"))
    s.SoundId = "rbxassetid://"..id
    s.Volume = vol or 0.6
    s:Play(); Debris:AddItem(s, 2)
end

local function applyExhaustion()
    if State.IsExhausted then return end
    State.IsExhausted = true
    State.CurrentRegenDelay = CONFIG.EXHAUSTED_REGEN_DELAY
    
    -- Efeito de Tontura e Fadiga
    local blur = Instance.new("BlurEffect", Lighting)
    blur.Size = 20
    
    local char = player.Character
    if char and char:FindFirstChild("Humanoid") then
        char.Humanoid.WalkSpeed = 8 -- Fadiga
    end
    
    task.delay(2, function()
        blur:Destroy()
        if char and char:FindFirstChild("Humanoid") then
            char.Humanoid.WalkSpeed = 16
        end
        State.IsExhausted = false
    end)
end

local function createChromaticTrail(char)
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if humanoid and humanoid.MoveDirection.Magnitude <= 0 then return end
    
    char.Archivable = true
    local clone = char:Clone()
    clone.Parent = workspace
    local duration = 0.8
    
    for _, obj in ipairs(clone:GetDescendants()) do
        if obj:IsA("BasePart") then
            obj.Anchored = true; obj.CanCollide = false; obj.Material = "Neon"
            obj.Color = CONFIG.MAIN_COLOR; obj.Transparency = 0.3
            TweenService:Create(obj, TweenInfo.new(duration), {Color = CONFIG.PURPLE_COLOR, Transparency = 1}):Play()
        elseif not (obj:IsA("MeshPart") or obj:IsA("SpecialMesh") or obj:IsA("Accessory")) then
            obj:Destroy()
        end
    end
    Debris:AddItem(clone, duration)
end

local function useEnergy(amount)
    State.Energy = math.max(0, State.Energy - amount)
    State.LastEnergyUse = tick()
    if State.Energy <= 0 then
        applyExhaustion()
        return true -- Retorna true se zerou
    end
    return false
end

-- HABILIDADES
function deactivateSlowTime()
    if not State.SlowActive then return end
    State.SlowActive = false; State.CanSandi = false
    playLocalSound(CONFIG.SOUND_DEACTIVATE)
    if State.Connections.Loop then State.Connections.Loop:Disconnect() end
    if Lighting:FindFirstChild("SandiCC") then Lighting.SandiCC:Destroy() end
    workspace.Gravity = 196.2
    
    if player.Character and player.Character:FindFirstChild("Humanoid") then 
        player.Character.Humanoid.WalkSpeed = 16 
    end
    
    task.spawn(function()
        SlowBtn.BackgroundColor3 = Color3.fromRGB(5, 5, 5)
        for i = 7, 1, -1 do SlowBtn.Text = tostring(i); task.wait(1) end
        SlowBtn.Text = "⏱"; SlowBtn.BackgroundColor3 = CONFIG.BG_DEFAULT; State.CanSandi = true
    end)
end

local function activateSlowTime()
    if State.DragMode or not State.CanSandi or State.Energy < CONFIG.SLOW_START_COST or State.IsExhausted then 
        playLocalSound(CONFIG.SOUND_ERROR); return 
    end
    
    State.SlowActive = true
    State.CurrentRegenDelay = CONFIG.NORMAL_REGEN_DELAY
    useEnergy(CONFIG.SLOW_START_COST)
    
    playLocalSound(CONFIG.SOUND_ACTIVATE); SlowBtn.BackgroundColor3 = Color3.fromRGB(0, 70, 70)
    local cc = Instance.new("ColorCorrectionEffect", Lighting); cc.Name = "SandiCC"; cc.TintColor = Color3.fromRGB(150, 255, 220)
    workspace.Gravity = 196.2 * 0.25
    
    State.Connections.Loop = RunService.RenderStepped:Connect(function(dt)
        local char = player.Character
        if char and char:FindFirstChild("Humanoid") then
            char.Humanoid.WalkSpeed = 16 * CONFIG.SANDI_SPEED_MULT
            createChromaticTrail(char)
        end
        if useEnergy(9 * dt) then deactivateSlowTime() end
    end)
end

local function performDash()
    if State.DragMode or not State.CanDash or State.Energy < CONFIG.DASH_COST or State.IsExhausted then 
        playLocalSound(CONFIG.SOUND_ERROR); return 
    end
    
    State.CanDash = false; useEnergy(CONFIG.DASH_COST); playLocalSound(CONFIG.SOUND_DASH)
    DashBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 0)
    
    local hrp = player.Character.HumanoidRootPart
    hrp.Velocity = camera.CFrame.LookVector * CONFIG.DASH_FORCE
    
    task.spawn(function() 
        for i = 1, 10 do createChromaticTrail(player.Character); task.wait(0.03) end
    end)
    
    task.delay(0.3, function()
        task.spawn(function()
            DashBtn.BackgroundColor3 = Color3.fromRGB(5, 5, 5)
            for i = 2, 1, -1 do DashBtn.Text = tostring(i); task.wait(1) end
            DashBtn.Text = "⚡"; DashBtn.BackgroundColor3 = CONFIG.BG_DEFAULT; State.CanDash = true
        end)
    end)
end

-- UI
local function setupUI()
    if player.PlayerGui:FindFirstChild("CyberHUD") then player.PlayerGui.CyberHUD:Destroy() end
    ScreenGui = Instance.new("ScreenGui", player.PlayerGui); ScreenGui.Name = "CyberHUD"; ScreenGui.ResetOnSpawn = false
    
    local function makeDraggable(obj)
        local dragging, dStart, sPos
        obj.InputBegan:Connect(function(input)
            if State.DragMode and (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch) then
                dragging = true; dStart = input.Position; sPos = obj.Position
            end
        end)
        UserInputService.InputChanged:Connect(function(input)
            if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                local delta = input.Position - dStart
                obj.Position = UDim2.new(sPos.X.Scale, sPos.X.Offset + delta.X, sPos.Y.Scale, sPos.Y.Offset + delta.Y)
            end
        end)
        UserInputService.InputEnded:Connect(function() dragging = false end)
    end

    local function createBtn(icon, color, strokeColor, pos, func)
        local btn = Instance.new("TextButton", ScreenGui); btn.Size = UDim2.fromOffset(60, 60); btn.Position = pos
        btn.BackgroundColor3 = CONFIG.BG_DEFAULT; btn.Text = icon; btn.TextColor3 = color; btn.TextSize = 28; btn.Font = "GothamBlack"
        Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 12)
        local stroke = Instance.new("UIStroke", btn); stroke.Color = strokeColor; stroke.Thickness = 3
        btn.MouseButton1Click:Connect(func); makeDraggable(btn)
        return btn
    end

    DashBtn = createBtn("⚡", CONFIG.SECONDARY_COLOR, CONFIG.SECONDARY_COLOR, UDim2.new(0.7, 0, 0.75, 0), performDash)
    SlowBtn = createBtn("⏱", CONFIG.MAIN_COLOR, CONFIG.MAIN_COLOR, UDim2.new(0.76, 0, 0.75, 0), function() if State.SlowActive then deactivateSlowTime() else activateSlowTime() end end)

    local function createBar(color, yPos, labelText)
        local frame = Instance.new("Frame", ScreenGui); frame.Size = UDim2.fromOffset(220, 10); frame.Position = UDim2.new(0.5, -110, 0, yPos); frame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
        Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 5)
        local fill = Instance.new("Frame", frame); fill.Size = UDim2.fromScale(1, 1); fill.BackgroundColor3 = color; Instance.new("UICorner", fill).CornerRadius = UDim.new(0, 5)
        local lbl = Instance.new("TextLabel", frame); lbl.Size = UDim2.fromOffset(50, 10); lbl.Position = UDim2.new(0, -55, 0, -1); lbl.BackgroundTransparency = 1; lbl.Text = labelText; lbl.TextColor3 = color; lbl.Font = "Code"; lbl.TextSize = 12; lbl.TextXAlignment = "Right"
        return fill
    end

    EnergyFill = createBar(CONFIG.MAIN_COLOR, 35, "NRG//")
    HealthFill = createBar(CONFIG.HEALTH_COLOR, 50, "VIT//")

    local ConfigBtn = Instance.new("TextButton", ScreenGui); ConfigBtn.Size = UDim2.fromOffset(30, 30); ConfigBtn.Text = "⚙"; ConfigBtn.Position = UDim2.fromOffset(25, 25); ConfigBtn.BackgroundColor3 = Color3.fromRGB(200, 200, 200); ConfigBtn.TextColor3 = Color3.fromRGB(50, 50, 50)
    Instance.new("UICorner", ConfigBtn).CornerRadius = UDim.new(1, 0)
    ConfigBtn.MouseButton1Click:Connect(function() State.DragMode = not State.DragMode; ConfigBtn.BackgroundColor3 = State.DragMode and Color3.fromRGB(100, 255, 100) or Color3.fromRGB(200, 200, 200) end)
end

-- LOOP PRINCIPAL
RunService.Heartbeat:Connect(function(dt)
    local now = tick()
    if now - State.LastEnergyUse > State.CurrentRegenDelay and not State.SlowActive then
        State.Energy = math.min(CONFIG.MAX_ENERGY, State.Energy + (CONFIG.REGEN_SPEED * dt))
    end
    if EnergyFill then EnergyFill.Size = UDim2.fromScale(State.Energy/CONFIG.MAX_ENERGY, 1) end
    if HealthFill and player.Character and player.Character:FindFirstChild("Humanoid") then
        HealthFill.Size = UDim2.fromScale(player.Character.Humanoid.Health / player.Character.Humanoid.MaxHealth, 1)
    end
end)

setupUI()
player.CharacterAdded:Connect(setupUI)
