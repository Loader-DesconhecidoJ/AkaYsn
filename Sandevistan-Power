--[[
    SANDEVISTAN DAVID MARTINEZ - PROFESSIONAL EDITION (V2)
    Updates: 
    - Cooldown Text Fixed (Yellow)
    - Speed Boost Reduced for better control
]]

-- 1. SERVICES
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Debris = game:GetService("Debris")
local Lighting = game:GetService("Lighting")
local SoundService = game:GetService("SoundService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- 2. CONFIGURATION
local CONFIG = {
    -- ABILITIES
    DASH_DISTANCE = 45,
    DASH_DURATION = 0.2,
    DASH_COOLDOWN = 4,
    
    SLOW_DURATION = 20, 
    SLOW_COOLDOWN = 10,
    SLOW_TIMESCALE = 0.3, -- Quão lento o mundo fica
    SLOW_WALKSPEED_MULTI = 1.1, -- [AJUSTADO] Multiplicador de velocidade (Menor = Mais controle)
    
    -- MECHANICS
    DEFLECT_RADIUS = 12, 
    EMERGENCY_HP_THRESHOLD = 25, 
    IMPACT_MIN_FALL_HEIGHT = 15, 
    
    -- VISUALS
    AFTERIMAGE_RATE = 0.08,
    MAIN_COLOR = Color3.fromRGB(0, 255, 220), -- Ciano Cyberpunk
    SECONDARY_COLOR = Color3.fromRGB(255, 255, 0), -- Amarelo Cyberpunk
    ALERT_COLOR = Color3.fromRGB(255, 50, 50), 
    
    TRAIL_COLORS = {
        Color3.fromRGB(0, 255, 255),
        Color3.fromRGB(0, 255, 128),
        Color3.fromRGB(30, 144, 255)
    },
    
    -- SOUNDS
    SOUND_ACTIVATE = 123844681344865,
    SOUND_DEACTIVATE = 118534165523355,
    SOUND_DASH = 103247005619946,
    SOUND_IMPACT = 130767405
}

-- 3. STATE MANAGEMENT
local State = {
    SlowActive = false,
    CanDash = true,
    CooldownActive = false,
    IsFalling = false,
    DragMode = false,
    Connections = {}
}

-- UI VARIABLES
local ScreenGui
local DashBtn, SlowBtn, ConfigBtn

-- 4. UTILITY FUNCTIONS
local function playSound(id, vol, pitch)
    if not id or id == 0 then return end
    local s = Instance.new("Sound")
    s.SoundId = "rbxassetid://"..id
    s.Volume = vol or 1
    s.Pitch = pitch or 1
    s.Parent = workspace
    s:Play()
    Debris:AddItem(s, 5)
    return s
end

local function toggleCollision(char, enabled)
    for _, part in ipairs(char:GetDescendants()) do
        if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
            part.CanCollide = enabled
        end
    end
end

-- 5. VISUAL EFFECTS (VFX)
local function createGhostTrail(char, colorOverride)
    if not char then return end
    
    char.Archivable = true
    local clone = char:Clone()
    clone.Name = "SandevistanGhost"
    
    for _, obj in ipairs(clone:GetDescendants()) do
        if obj:IsA("BasePart") then
            obj.Anchored = true
            obj.CanCollide = false
            obj.Material = Enum.Material.Neon
            obj.Color = colorOverride or CONFIG.TRAIL_COLORS[math.random(1, #CONFIG.TRAIL_COLORS)]
            obj.Transparency = 0.6
            obj.CastShadow = false
        elseif not obj:IsA("MeshPart") and not obj:IsA("SpecialMesh") and not obj:IsA("Accessory") then
            obj:Destroy()
        end
    end
    
    clone.Parent = workspace
    
    for _, obj in ipairs(clone:GetDescendants()) do
        if obj:IsA("BasePart") then
            TweenService:Create(obj, TweenInfo.new(0.5), {Transparency = 1, Size = obj.Size * 0.95}):Play()
        end
    end
    Debris:AddItem(clone, 0.5)
end

local function spawnImpactEffect(position)
    local shock = Instance.new("Part")
    shock.Shape = Enum.PartType.Ball
    shock.Material = Enum.Material.Neon
    shock.Color = CONFIG.SECONDARY_COLOR
    shock.Anchored = true
    shock.CanCollide = false
    shock.Position = position
    shock.Size = Vector3.new(1,1,1)
    shock.Parent = workspace
    
    TweenService:Create(shock, TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
        Size = Vector3.new(30, 30, 30),
        Transparency = 1
    }):Play()
    Debris:AddItem(shock, 0.5)
    
    for i = 1, 8 do
        local rock = Instance.new("Part")
        rock.Size = Vector3.new(math.random(1,2), math.random(1,2), math.random(1,2))
        rock.Material = Enum.Material.Concrete
        rock.Color = Color3.fromRGB(50,50,50)
        rock.Position = position + Vector3.new(0,2,0)
        rock.Velocity = Vector3.new(math.random(-40,40), math.random(30,60), math.random(-40,40))
        rock.Parent = workspace
        Debris:AddItem(rock, 2)
    end
    
    playSound(CONFIG.SOUND_IMPACT, 2, 0.8)
    
    local originalOff = camera.CFrame
    task.spawn(function()
        for i=1, 6 do
            camera.CFrame = camera.CFrame * CFrame.new(math.random()-0.5, math.random()-0.5, 0)
            task.wait(0.03)
        end
    end)
end

local function deflectProjectiles()
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    local parts = workspace:GetPartBoundsInRadius(hrp.Position, CONFIG.DEFLECT_RADIUS)
    for _, part in ipairs(parts) do
        if part:IsA("BasePart") and not part.Anchored and not part:IsDescendantOf(char) then
            local spark = Instance.new("Part")
            spark.Size = Vector3.new(0.5,0.5,0.5)
            spark.Material = Enum.Material.Neon
            spark.Color = Color3.fromRGB(255,255,255)
            spark.CFrame = part.CFrame
            spark.Anchored = true; spark.CanCollide = false
            spark.Parent = workspace
            Debris:AddItem(spark, 0.1)
            
            local dir = (part.Position - hrp.Position).Unit
            part.AssemblyLinearVelocity = (dir + Vector3.new(0, 0.5, 0)) * 100
        end
    end
end

-- 6. CORE LOGIC
local function updateWorldDistortion(active)
    if active then
        local cc = Instance.new("ColorCorrectionEffect")
        cc.Name = "SandiCC"
        cc.TintColor = Color3.fromRGB(150, 255, 200)
        cc.Saturation = -0.4
        cc.Contrast = 0.2
        cc.Parent = Lighting
        
        local blur = Instance.new("BlurEffect")
        blur.Name = "SandiBlur"
        blur.Size = 0
        blur.Parent = Lighting
        TweenService:Create(blur, TweenInfo.new(0.5), {Size = 8}):Play()
        
        workspace.Gravity = 196.2 * CONFIG.SLOW_TIMESCALE
        
        local dist = Instance.new("DistortionSoundEffect")
        dist.Name = "SandiDistort"
        dist.Level = 0.8
        dist.Parent = SoundService
    else
        for _, v in ipairs(Lighting:GetChildren()) do
            if v.Name == "SandiCC" or v.Name == "SandiBlur" then v:Destroy() end
        end
        if SoundService:FindFirstChild("SandiDistort") then SoundService.SandiDistort:Destroy() end
        workspace.Gravity = 196.2
    end
end

local function activateSlowTime()
    if State.SlowActive or State.CooldownActive then return end
    State.SlowActive = true
    
    playSound(CONFIG.SOUND_ACTIVATE)
    updateWorldDistortion(true)
    
    State.Connections.Loop = RunService.RenderStepped:Connect(function()
        local char = player.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        
        if hrp and State.SlowActive then
            if char.Humanoid.MoveDirection.Magnitude > 0 then
                createGhostTrail(char)
            end
            
            -- [AJUSTADO] Velocidade agora usa o novo multiplicador CONFIG.SLOW_WALKSPEED_MULTI
            local baseSpeed = 16
            local timeScaleComp = (1 / CONFIG.SLOW_TIMESCALE) -- Compensa o tempo lento
            char.Humanoid.WalkSpeed = baseSpeed * timeScaleComp * CONFIG.SLOW_WALKSPEED_MULTI
        end
    end)
    
    State.Connections.Deflect = RunService.Heartbeat:Connect(function()
        if State.SlowActive then deflectProjectiles() end
    end)
    
    task.delay(CONFIG.SLOW_DURATION, function()
        if State.SlowActive then deactivateSlowTime(true) end
    end)
end

function deactivateSlowTime(auto)
    if not State.SlowActive then return end
    State.SlowActive = false
    
    if State.Connections.Loop then State.Connections.Loop:Disconnect() end
    if State.Connections.Deflect then State.Connections.Deflect:Disconnect() end
    
    updateWorldDistortion(false)
    playSound(CONFIG.SOUND_DEACTIVATE)
    
    local char = player.Character
    if char then char.Humanoid.WalkSpeed = 16 end
    
    State.CooldownActive = true
    local cdTime = auto and CONFIG.SLOW_COOLDOWN * 1.5 or CONFIG.SLOW_COOLDOWN
    
    task.spawn(function()
        for i = math.floor(cdTime), 1, -1 do
            if SlowBtn then SlowBtn.Label.Text = tostring(i) end
            task.wait(1)
        end
        if SlowBtn then SlowBtn.Label.Text = "⏱" end
        State.CooldownActive = false
    end)
end

local function performDash()
    if not State.CanDash then return end
    State.CanDash = false
    
    local char = player.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    playSound(CONFIG.SOUND_DASH, 1, 1.2)
    toggleCollision(char, false)
    
    TweenService:Create(camera, TweenInfo.new(0.1), {FieldOfView = 100}):Play()
    
    local bv = Instance.new("BodyVelocity")
    bv.MaxForce = Vector3.new(1e5, 1e5, 1e5)
    bv.Velocity = camera.CFrame.LookVector * (CONFIG.DASH_DISTANCE / CONFIG.DASH_DURATION)
    bv.Parent = hrp
    Debris:AddItem(bv, CONFIG.DASH_DURATION)
    
    local dashTrail = RunService.RenderStepped:Connect(function()
        createGhostTrail(char, Color3.fromRGB(0,255,255))
    end)
    
    task.delay(CONFIG.DASH_DURATION, function()
        dashTrail:Disconnect()
        toggleCollision(char, true)
        TweenService:Create(camera, TweenInfo.new(0.3), {FieldOfView = 70}):Play()
    end)
    
    -- [AJUSTADO] Cooldown Visual
    local cd = State.SlowActive and 0.5 or CONFIG.DASH_COOLDOWN
    task.spawn(function()
        for i = math.ceil(cd), 1, -1 do
            if DashBtn then 
                DashBtn.Label.TextColor3 = CONFIG.SECONDARY_COLOR -- Texto Amarelo
                DashBtn.Label.Text = tostring(i) 
            end
            task.wait(1)
        end
        if DashBtn then 
            DashBtn.Label.TextColor3 = CONFIG.SECONDARY_COLOR -- Reseta cor
            DashBtn.Label.Text = "⚡" 
        end
        State.CanDash = true
    end)
end

-- 7. UI CONSTRUCTION
local function createStyledButton(name, icon, color, pos)
    local frame = Instance.new("Frame")
    frame.Name = name
    frame.Size = UDim2.fromOffset(60, 60)
    frame.Position = pos
    frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    frame.Parent = ScreenGui
    
    local uiCorner = Instance.new("UICorner")
    uiCorner.CornerRadius = UDim.new(0.3, 0)
    uiCorner.Parent = frame
    
    local stroke = Instance.new("UIStroke")
    stroke.Thickness = 2
    stroke.Color = color
    stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    stroke.Parent = frame
    
    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255,255,255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(150,150,150))
    }
    gradient.Rotation = 45
    gradient.Parent = frame
    
    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.Size = UDim2.fromScale(1,1)
    label.BackgroundTransparency = 1
    label.Text = icon
    label.TextColor3 = color
    label.Font = Enum.Font.GothamBlack
    label.TextSize = 28
    label.Parent = frame
    
    frame.InputBegan:Connect(function(input)
        if State.DragMode then return end
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            frame:TweenSize(UDim2.fromOffset(50, 50), "Out", "Quad", 0.1, true)
        end
    end)
    
    frame.InputEnded:Connect(function(input)
        if State.DragMode then return end
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            frame:TweenSize(UDim2.fromOffset(60, 60), "Out", "Back", 0.2, true)
        end
    end)
    
    return frame
end

local function setupUI()
    if player.PlayerGui:FindFirstChild("CyberpunkHUD") then player.PlayerGui.CyberpunkHUD:Destroy() end
    
    ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "CyberpunkHUD"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = player.PlayerGui
    
    DashBtn = createStyledButton("DashBtn", "⚡", CONFIG.SECONDARY_COLOR, UDim2.fromScale(0.85, 0.7))
    SlowBtn = createStyledButton("SlowBtn", "⏱", CONFIG.MAIN_COLOR, UDim2.fromScale(0.75, 0.7))
    
    DashBtn.InputBegan:Connect(function(i) 
        if not State.DragMode and (i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch) then
            performDash()
        end
    end)
    
    SlowBtn.InputBegan:Connect(function(i)
        if not State.DragMode and (i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch) then
            if State.SlowActive then deactivateSlowTime(false) else activateSlowTime() end
        end
    end)
    
    ConfigBtn = Instance.new("TextButton")
    ConfigBtn.Size = UDim2.fromOffset(30,30)
    ConfigBtn.Position = UDim2.fromScale(0.01, 0.01)
    ConfigBtn.BackgroundColor3 = Color3.fromRGB(40,40,40)
    ConfigBtn.Text = "⚙️"
    ConfigBtn.TextColor3 = Color3.new(1,1,1)
    ConfigBtn.Parent = ScreenGui
    Instance.new("UICorner", ConfigBtn).CornerRadius = UDim.new(0.5,0)
    
    ConfigBtn.MouseButton1Click:Connect(function()
        State.DragMode = not State.DragMode
        ConfigBtn.BackgroundColor3 = State.DragMode and CONFIG.MAIN_COLOR or Color3.fromRGB(40,40,40)
    end)
end

-- 8. DRAG SYSTEM
local function enableDragging(frame)
    local dragging, dragInput, dragStart, startPos
    
    frame.InputBegan:Connect(function(input)
        if State.DragMode and (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch) then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input == dragInput then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

-- 9. INITIALIZATION & EVENTS
local function onCharacterAdded(char)
    local hum = char:WaitForChild("Humanoid")
    local hrp = char:WaitForChild("HumanoidRootPart")
    
    State.IsFalling = false
    
    hum.HealthChanged:Connect(function(health)
        if health < (hum.MaxHealth * (CONFIG.EMERGENCY_HP_THRESHOLD/100)) and health > 0 and not State.SlowActive and not State.CooldownActive then
            local alarm = Instance.new("ColorCorrectionEffect")
            alarm.TintColor = CONFIG.ALERT_COLOR
            alarm.Parent = Lighting
            Debris:AddItem(alarm, 0.5)
            
            activateSlowTime()
        end
    end)
    
    task.spawn(function()
        while char.Parent do
            local state = hum:GetState()
            
            if state == Enum.HumanoidStateType.Freefall then
                if not State.IsFalling then
                    State.IsFalling = true
                    State.FallStartY = hrp.Position.Y
                end
            elseif state == Enum.HumanoidStateType.Landed then
                if State.IsFalling then
                    State.IsFalling = false
                    local fallDist = (State.FallStartY or hrp.Position.Y) - hrp.Position.Y
                    
                    if fallDist > CONFIG.IMPACT_MIN_FALL_HEIGHT and State.SlowActive then
                        spawnImpactEffect(hrp.Position - Vector3.new(0,3,0))
                    end
                end
            end
            task.wait(0.1)
        end
    end)
end

setupUI()
enableDragging(DashBtn)
enableDragging(SlowBtn)

if player.Character then onCharacterAdded(player.Character) end
player.CharacterAdded:Connect(onCharacterAdded)

player.CharacterRemoving:Connect(function()
    deactivateSlowTime(false)
end)
